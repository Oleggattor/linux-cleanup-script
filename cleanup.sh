#!/bin/bash



# üìù –õ–æ–≥-—Ñ–∞–π–ª



LOG_FILE="/var/log/system_cleanup_$(date +%Y%m%d).log"



CURRENT_KERNEL="$(uname -r)"



export LC_ALL=C



# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤



if [ "$(id -u)" -ne 0 ]; then



echo "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫ –æ—Ç root (—á–µ—Ä–µ–∑ sudo)!"



exit 1



fi



# –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–∞



touch "$LOG_FILE" && chmod 640 "$LOG_FILE"



echo "üßπ –ß–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã –Ω–∞—á–∞–ª–∞—Å—å..." | tee -a "$LOG_FILE"



echo "üìÑ –õ–æ–≥: $LOG_FILE" | tee -a "$LOG_FILE"



echo "--------------------------------------" | tee -a "$LOG_FILE"



{



echo "=== $(date '+%F %T') ==="



echo "‚ö†Ô∏è –¢–µ–∫—É—â–µ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —è–¥—Ä–æ: $CURRENT_KERNEL"



echo



# üíæ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–æ



echo "üíæ –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –¥–æ –æ—á–∏—Å—Ç–∫–∏:"



df -h /



# üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π)



# echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."



# apt update && apt upgrade -y



# üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ APT



echo "üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ apt..."



apt autoremove -y



apt autoclean



apt clean



# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø–∞–∫–µ—Ç–æ–≤



echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏—Ç—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."



apt install -f -y



dpkg -C || echo "‚ö†Ô∏è –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å dpkg, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é."



# üìÅ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤



echo "üìÅ –û—á–∏—Å—Ç–∫–∞ systemd-–∂—É—Ä–Ω–∞–ª–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)..."



journalctl --vacuum-time=7d



# üßº –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∏ –∫–æ—Ä–∑–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π



echo "üßº –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∏ –º—É—Å–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."



for home in /home/*; do



[ -d "$home" ] || continue



user=$(basename "$home")



echo "‚Üí $user"



rm -rf "$home/.cache/"* "$home/.local/share/Trash/"* 2>/dev/null



done



# üßΩ –û—á–∏—Å—Ç–∫–∞ /tmp (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–∫–µ—Ç–æ–≤ –∏ –ø–∞–π–ø–æ–≤)



echo "üßΩ –û—á–∏—Å—Ç–∫–∞ /tmp..."



find /tmp -mindepth 1 -maxdepth 1 -mtime +1 ! -type s ! -type p -exec rm -rf {} + 2>/dev/null



# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫ deborphan



if ! command -v deborphan >/dev/null 2>&1; then



echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ deborphan..."



apt install -y deborphan



fi



echo "üîé –ü–æ–∏—Å–∫ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫..."



orphans=$(deborphan 2>/dev/null)



if [ -n "$orphans" ]; then



echo "–£–¥–∞–ª–µ–Ω–∏–µ: $orphans"



apt remove -y --purge $orphans



else



echo "–û—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."



fi



# üß® –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —è–¥–µ—Ä (–±–µ–∑ —Ç–µ–∫—É—â–µ–≥–æ)



echo "üß® –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —è–¥–µ—Ä..."



dpkg -l | awk '/^ii linux-image-[0-9]/ { print $2 }' | grep -v "$CURRENT_KERNEL" | while read -r kernel; do



echo "–£–¥–∞–ª—è–µ—Ç—Å—è: $kernel"



apt remove -y --purge "$kernel"



done



# üíæ –î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ—Å–ª–µ



echo



echo "üíæ –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:"



df -h /



echo



echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –°–∏—Å—Ç–µ–º–∞ –ø–æ—á–∏—â–µ–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞."



} 2>&1 | tee -a "$LOG_FILE"



echo "--------------------------------------" | tee -a "$LOG_FILE"



echo "üìÑ –õ–æ–≥ –∑–∞–ø–∏—Å–∞–Ω –≤: $LOG_FILE" | tee -a "$LOG_FILE"
